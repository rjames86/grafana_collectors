services:
  influxdb2:
    container_name: influxdb2
    image: influxdb:latest
    volumes:
      - ./data/influxdb2:/var/lib/influxdb2:rw
    ports:
      - 8087:8086
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8086/ping
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always
  grafana:
    container_name: grafana
    build: ./grafana
    environment:
      GF_AUTH_ANONYMOUS_ORG_ROLE: Editor
      GF_AUTH_ANONYMOUS_ENABLED: "false"
      TZ: America/Denver
    ports:
      - 3000:3000
    restart: always
    volumes:
      - ./data/grafana:/var/lib/grafana
  mosquitto:
    container_name: mosquitto
    image: eclipse-mosquitto
    hostname: mosquitto
    restart: unless-stopped
    ports:
      - 1883:1883
      - 9001:9001
    volumes:
      - ./data/mosquitto:/mosquitto/config
  # Data Collection Services
  api:
    container_name: api
    build: ./api
    depends_on:
      - influxdb2
    ports:
      - 8080:5000
    restart: always
    volumes:
      - ./api:/app
    entrypoint:
      - flask
      - run
      - --host=0.0.0.0
    env_file: .env
    environment:
      FLASK_DEBUG: 1
      FLASK_APP: ./main.py
    healthcheck:
      test:
        - CMD
        - wget
        - --quiet
        - --tries=1
        - --spider
        - http://127.0.0.1:5000/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  ecobee-collector:
    container_name: ecobee-collector
    build: ./ecobee_influx_connector
    depends_on:
      - influxdb2
      - grafana
    env_file: .env
    environment:
      ECOBEE_WORK_DIR: /var/lib/ecobee_collector
      ECOBEE_INFLUX_SERVER: ${WEATHERFLOW_COLLECTOR_INFLUXDB_URL}
      ECOBEE_INFLUX_BUCKET: ecobee
      ECOBEE_INFLUX_ORG: ${WEATHERFLOW_COLLECTOR_INFLUXDB_ORG}
      ECOBEE_INFLUX_TOKEN: ${WEATHERFLOW_COLLECTOR_INFLUXDB_TOKEN}
      ECOBEE_ALWAYS_WRITE_WEATHER_AS_CURRENT: "false"
      ECOBEE_WRITE_HEAT_PUMP_1: "true"
      ECOBEE_WRITE_HEAT_PUMP_2: "true"
      ECOBEE_WRITE_AUX_HEAT_1: "true"
      ECOBEE_WRITE_AUX_HEAT_2: "true"
      ECOBEE_WRITE_COOL_1: "true"
      ECOBEE_WRITE_COOL_2: "true"
      ECOBEE_WRITE_HUMIDIFIER: "true"
    volumes:
      - ./data/ecobee_collector:/var/lib/ecobee_collector
    restart: always
  solaredge-collector:
    container_name: solaredge-collector
    build: ./solaredge
    depends_on:
      - api
    environment:
      SOLAREDGE_SITE_ID: ${SOLAREDGE_SITE_ID}
      SOLAREDGE_TOKEN: ${SOLAREDGE_TOKEN}
    volumes:
      - ./data/solaredge_collector:/var/lib/solaredge_collector
    restart: always
  purpleair-collector:
    container_name: purpleair-collector
    build: ./purpleair
    depends_on:
      - api
      - grafana
    environment:
      SENSOR_ID: "187589"
      INFLUX_DB: purpleair
    volumes:
      - ./data/purpleair:/var/lib/purpleair
    restart: always
  weatherflow-collector-v2:
    container_name: weatherflow-collector-v2
    build: ./weatherflow-collector
    restart: always
    depends_on:
      influxdb2:
        condition: service_healthy
      grafana:
        condition: service_started
    env_file: .env
    ports:
      - 50222:50222/udp
    working_dir: /app/weatherflow-collector
    volumes:
      - ./data/weatherflow-collector-v2:/var/lib/weatherflow-collector
  mqtt-client:
    container_name: mqtt-client
    build: ./mqtt_client
    restart: always
    depends_on:
      - mosquitto
      - api
    entrypoint:
      - python
      - main.py
    environment:
      MQTT_USERNAME: ${MQTT_USERNAME}
      MQTT_PASSWORD: ${MQTT_PASSWORD}
      MQTT_BROKER: mosquitto
  rivian-collector:
    build:
      context: .
      dockerfile: ./rivflux/docker/rivian/Dockerfile
    container_name: rivian-collector
    restart: unless-stopped
    volumes:
      - ./rivflux/data/auth:/app
    command: [
      "-auth-file=/app/auth.json",
      "-influx-url=http://influxdb2:8086",
      "-influx-token=${INFLUX_TOKEN}",
      "-influx-org=ryanm",
      "-influx-bucket=rivian",
      "-poll-interval=300"
    ]
    depends_on:
      - influxdb2
    healthcheck:
      test: ["CMD", "ps", "aux", "|", "grep", "logger"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
networks: {}
